
name: Infrastructure Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  terraform-plan:
    name: Terraform Plan & Drift Detection
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: ./infra/terraform
        run: terraform init

      - name: Create terraform.tfvars
        working-directory: ./infra/terraform
        run: |
          cat > terraform.tfvars << TFVARS
          aws_region      = "${{ env.AWS_REGION }}"
          project_name    = "todo-microservices"
          environment     = "production"
          instance_type   = "t3.medium"
          key_name        = "${{ secrets.EC2_KEY_NAME }}"
          ssh_user        = "ubuntu"
          ssh_key_path    = "/home/runner/.ssh/devops-stage6-key.pem"
          domain_name     = "${{ secrets.DOMAIN_NAME }}"
          allowed_ssh_ips = ["0.0.0.0/0"]
          TFVARS

      - name: Terraform Plan
        id: plan
        working-directory: ./infra/terraform
        run: |
          terraform plan -detailed-exitcode -out=tfplan || export exitcode=$?
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
          
          if [ $exitcode -eq 1 ]; then
            echo "❌ Terraform Plan Failed"
            exit 1
          elif [ $exitcode -eq 2 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "⚠️ Infrastructure drift detected!"
            echo "### ⚠️ Infrastructure Drift Detected" >> $GITHUB_STEP_SUMMARY
            echo "Manual approval required before applying changes" >> $GITHUB_STEP_SUMMARY
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "✅ No changes needed"
            echo "### ✅ No Infrastructure Changes" >> $GITHUB_STEP_SUMMARY
            echo "Infrastructure matches configuration" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Save Plan
        if: steps.plan.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infra/terraform/tfplan
          retention-days: 1

  send-drift-notification:
    name: Send Drift Detection Email
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: needs.terraform-plan.outputs.has_changes == 'true'
    
    steps:
      - name: Send Email via SendGrid
        uses: peter-evans/sendgrid-action@v1
        with:
          api-key: ${{ secrets.SENDGRID_API_KEY }}
          from: ${{ secrets.SENDGRID_FROM_EMAIL }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          subject: '⚠️ Infrastructure Drift Detected - Approval Required'
          html: |
            <h2>⚠️ Infrastructure Drift Detected</h2>
            <p>Changes have been detected in your TODO Microservices infrastructure.</p>
            
            <h3>Details:</h3>
            <ul>
              <li><strong>Repository:</strong> ${{ github.repository }}</li>
              <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
              <li><strong>Commit:</strong> ${{ github.sha }}</li>
              <li><strong>Triggered by:</strong> ${{ github.actor }}</li>
            </ul>
            
            <h3>Action Required:</h3>
            <p>Manual approval is required before applying infrastructure changes.</p>
            <ol>
              <li>Review the Terraform plan</li>
              <li>Go to the <a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">GitHub Actions run</a></li>
              <li>Click "Review deployments" and approve</li>
            </ol>
            
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Full Run →</a></p>

  wait-for-approval:
    name: Wait for Manual Approval
    runs-on: ubuntu-latest
    needs: [terraform-plan, send-drift-notification]
    if: needs.terraform-plan.outputs.has_changes == 'true'
    environment:
      name: production
    
    steps:
      - name: Approval checkpoint
        run: |
          echo "✅ Deployment approved by ${{ github.actor }}"
          echo "### ✅ Approval Granted" >> $GITHUB_STEP_SUMMARY
          echo "Approved by: ${{ github.actor }}" >> $GITHUB_STEP_SUMMARY

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan, wait-for-approval]
    if: needs.terraform-plan.outputs.has_changes == 'true'
    outputs:
      server_ip: ${{ steps.outputs.outputs.server_ip }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/devops-stage6-key.pem
          chmod 400 ~/.ssh/devops-stage6-key.pem

      - name: Terraform Init
        working-directory: ./infra/terraform
        run: terraform init

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: infra/terraform/

      - name: Terraform Apply
        working-directory: ./infra/terraform
        run: terraform apply tfplan

      - name: Save Outputs
        id: outputs
        working-directory: ./infra/terraform
        run: |
          SERVER_IP=$(terraform output -raw server_public_ip)
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "### ✅ Infrastructure Applied" >> $GITHUB_STEP_SUMMARY
          echo "- **Server IP**: $SERVER_IP" >> $GITHUB_STEP_SUMMARY

  ansible-deploy:
    name: Deploy Application with Ansible
    runs-on: ubuntu-latest
    needs: terraform-apply
    if: needs.terraform-plan.outputs.has_changes == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/devops-stage6-key.pem
          chmod 400 ~/.ssh/devops-stage6-key.pem
          ssh-keyscan -H ${{ needs.terraform-apply.outputs.server_ip }} >> ~/.ssh/known_hosts

      - name: Create Ansible Inventory
        run: |
          mkdir -p infra/ansible/inventories
          cat > infra/ansible/inventories/hosts.ini << INVENTORY
          [app_servers]
          todo-app ansible_host=${{ needs.terraform-apply.outputs.server_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=$HOME/.ssh/devops-stage6-key.pem ansible_ssh_common_args='-o IdentitiesOnly=yes -o StrictHostKeyChecking=no'
          
          [app_servers:vars]
          ansible_python_interpreter=/usr/bin/python3
          ansible_become_method=sudo
          ansible_become=yes
          domain_name=${{ secrets.DOMAIN_NAME }}
          INVENTORY

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Run Ansible Playbook
        working-directory: ./infra/ansible
        run: |
          ansible-playbook -i inventories/hosts.ini playbook.yml

      - name: Send Success Email
        uses: peter-evans/sendgrid-action@v1
        with:
          api-key: ${{ secrets.SENDGRID_API_KEY }}
          from: ${{ secrets.SENDGRID_FROM_EMAIL }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          subject: '✅ Infrastructure Deployment Successful'
          html: |
            <h2>✅ Deployment Successful</h2>
            <p>Infrastructure changes have been successfully applied and the application is deployed.</p>
            
            <h3>Details:</h3>
            <ul>
              <li><strong>Repository:</strong> ${{ github.repository }}</li>
              <li><strong>Branch:</strong> ${{ github.ref_name }}</li>
              <li><strong>Application URL:</strong> <a href="https://${{ secrets.DOMAIN_NAME }}">https://${{ secrets.DOMAIN_NAME }}</a></li>
            </ul>
            
            <p><a href="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}">View Run Details →</a></p>

      - name: Deployment Summary
        run: |
          echo "### ✅ Deployment Complete" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Success" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://${{ secrets.DOMAIN_NAME }}" >> $GITHUB_STEP_SUMMARY
