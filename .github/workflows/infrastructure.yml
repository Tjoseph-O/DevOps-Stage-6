
name: Infrastructure Deployment

on:
  push:
    branches:
      - main
    paths:
      - 'infra/terraform/**'
      - 'infra/ansible/**'
      - '.github/workflows/infrastructure.yml'
  workflow_dispatch:

env:
  AWS_REGION: us-east-1
  TERRAFORM_VERSION: 1.6.0

jobs:
  terraform-plan:
    name: Terraform Plan & Drift Detection
    runs-on: ubuntu-latest
    outputs:
      has_changes: ${{ steps.plan.outputs.has_changes }}
      plan_exitcode: ${{ steps.plan.outputs.exitcode }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}

      - name: Terraform Init
        working-directory: ./infra/terraform
        run: terraform init

      - name: Create terraform.tfvars
        working-directory: ./infra/terraform
        run: |
          cat > terraform.tfvars << TFVARS
          aws_region      = "${{ env.AWS_REGION }}"
          project_name    = "todo-microservices"
          environment     = "production"
          instance_type   = "t3.medium"
          key_name        = "${{ secrets.EC2_KEY_NAME }}"
          ssh_user        = "ubuntu"
          ssh_key_path    = "/home/runner/.ssh/devops-stage6-key.pem"
          domain_name     = "${{ secrets.DOMAIN_NAME }}"
          allowed_ssh_ips = ["0.0.0.0/0"]
          TFVARS

      - name: Terraform Plan
        id: plan
        working-directory: ./infra/terraform
        run: |
          terraform plan -detailed-exitcode -out=tfplan || export exitcode=$?
          echo "exitcode=$exitcode" >> $GITHUB_OUTPUT
          
          if [ $exitcode -eq 1 ]; then
            echo "❌ Terraform Plan Failed"
            exit 1
          elif [ $exitcode -eq 2 ]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "⚠️ Infrastructure drift detected!"
          else
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "✅ No changes needed"
          fi

      - name: Save Plan
        if: steps.plan.outputs.has_changes == 'true'
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: infra/terraform/tfplan
          retention-days: 1

  send-drift-notification:
    name: Send Drift Detection Email
    runs-on: ubuntu-latest
    needs: terraform-plan
    if: needs.terraform-plan.outputs.has_changes == 'true'
    
    steps:
      - name: Send Email Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: '⚠️ Infrastructure Drift Detected - Approval Required'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: DevOps Stage 6 CI/CD <${{ secrets.EMAIL_USERNAME }}>
          body: |
            Infrastructure drift has been detected in the TODO Microservices application.
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Triggered by: ${{ github.actor }}
            
            Changes detected in Terraform plan. Manual approval required before applying changes.
            
            To approve and apply changes:
            1. Go to: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            2. Review the Terraform plan
            3. Click "Review deployments" and approve
            
            View full run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

  wait-for-approval:
    name: Wait for Manual Approval
    runs-on: ubuntu-latest
    needs: [terraform-plan, send-drift-notification]
    if: needs.terraform-plan.outputs.has_changes == 'true'
    environment:
      name: production
    
    steps:
      - name: Approval checkpoint
        run: echo "✅ Deployment approved by ${{ github.actor }}"

  terraform-apply:
    name: Terraform Apply
    runs-on: ubuntu-latest
    needs: [terraform-plan, wait-for-approval]
    if: needs.terraform-plan.outputs.has_changes == 'true'
    outputs:
      server_ip: ${{ steps.outputs.outputs.server_ip }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/devops-stage6-key.pem
          chmod 400 ~/.ssh/devops-stage6-key.pem

      - name: Terraform Init
        working-directory: ./infra/terraform
        run: terraform init

      - name: Download Plan
        uses: actions/download-artifact@v4
        with:
          name: terraform-plan
          path: infra/terraform/

      - name: Terraform Apply
        working-directory: ./infra/terraform
        run: terraform apply tfplan

      - name: Save Outputs
        id: outputs
        working-directory: ./infra/terraform
        run: |
          SERVER_IP=$(terraform output -raw server_public_ip)
          echo "server_ip=$SERVER_IP" >> $GITHUB_OUTPUT
          echo "Server IP: $SERVER_IP"

  ansible-deploy:
    name: Deploy Application with Ansible
    runs-on: ubuntu-latest
    needs: terraform-apply
    if: needs.terraform-plan.outputs.has_changes == 'true'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH Key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.EC2_PRIVATE_KEY }}" > ~/.ssh/devops-stage6-key.pem
          chmod 400 ~/.ssh/devops-stage6-key.pem
          ssh-keyscan -H ${{ needs.terraform-apply.outputs.server_ip }} >> ~/.ssh/known_hosts

      - name: Create Ansible Inventory
        run: |
          mkdir -p infra/ansible/inventories
          cat > infra/ansible/inventories/hosts.ini << INVENTORY
          [app_servers]
          todo-app ansible_host=${{ needs.terraform-apply.outputs.server_ip }} ansible_user=ubuntu ansible_ssh_private_key_file=$HOME/.ssh/devops-stage6-key.pem ansible_ssh_common_args='-o IdentitiesOnly=yes -o StrictHostKeyChecking=no'
          
          [app_servers:vars]
          ansible_python_interpreter=/usr/bin/python3
          ansible_become_method=sudo
          ansible_become=yes
          domain_name=${{ secrets.DOMAIN_NAME }}
          INVENTORY

      - name: Install Ansible
        run: |
          sudo apt-get update
          sudo apt-get install -y ansible

      - name: Run Ansible Playbook
        working-directory: ./infra/ansible
        run: |
          ansible-playbook -i inventories/hosts.ini playbook.yml

      - name: Deployment Success Notification
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.EMAIL_USERNAME }}
          password: ${{ secrets.EMAIL_PASSWORD }}
          subject: '✅ Infrastructure Deployment Successful'
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: DevOps Stage 6 CI/CD <${{ secrets.EMAIL_USERNAME }}>
          body: |
            Infrastructure changes have been successfully applied.
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Deployment URL: https://${{ secrets.DOMAIN_NAME }}
            
            View run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
